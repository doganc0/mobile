name: Mobile App Build

on:
  workflow_dispatch:
  repository_dispatch:
    types: [mobile_app_build]

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
      - name: Flutter Pub Get
        run: |
          cd mobile_app
          flutter pub get
      - name: Build APK
        run: |
          cd mobile_app
          flutter build apk --dart-define=CONFIG_URL=${{ secrets.CONFIG_URL }}
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-apk
          path: mobile_app/build/app/outputs/flutter-apk/app-release.apk
      - name: Upload APK to Panel
        if: ${{ secrets.APP_UPLOAD_URL != '' }}
        run: |
          curl -X POST "${{ secrets.APP_UPLOAD_URL }}" \
            -H "X-App-Token: ${{ secrets.APP_UPLOAD_TOKEN }}" \
            -F "apk=@mobile_app/build/app/outputs/flutter-apk/app-release.apk" \
            -F "android_version=${{ github.run_number }}"

  ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
      - name: Flutter Pub Get
        run: |
          cd mobile_app
          flutter pub get
      - name: Build IPA (no codesign)
        run: |
          cd mobile_app
          flutter build ipa --no-codesign --dart-define=CONFIG_URL=${{ secrets.CONFIG_URL }}
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-ipa
          path: mobile_app/build/ios/ipa/*.ipa
      - name: Upload IPA to Panel
        if: ${{ secrets.APP_UPLOAD_URL != '' }}
        run: |
          IPA_FILE=$(ls mobile_app/build/ios/ipa/*.ipa | head -n 1)
          curl -X POST "${{ secrets.APP_UPLOAD_URL }}" \
            -H "X-App-Token: ${{ secrets.APP_UPLOAD_TOKEN }}" \
            -F "ipa=@${IPA_FILE}" \
            -F "ios_version=${{ github.run_number }}"
